<%- include('base', { title: 'Dashboard - OfferEarner' }) %>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome back, <%= user.username %>!</h1>
        <p>Here's your earning overview</p>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ðŸ’°</div>
            <div class="stat-content">
                <h3>Total Earned</h3>
                <p class="stat-value">$<%= user.totalEarned.toFixed(2) %></p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ðŸ’³</div>
            <div class="stat-content">
                <h3>Account Balance</h3>
                <p class="stat-value">$<%= user.balance.toFixed(2) %></p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
                <h3>Tasks Completed</h3>
                <p class="stat-value"><%= user.tasksCompleted %></p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ðŸ“Š</div>
            <div class="stat-content">
                <h3>Average Per Task</h3>
                <p class="stat-value">$<%= user.tasksCompleted > 0 ? (user.totalEarned / user.tasksCompleted).toFixed(2) : '0.00' %></p>
            </div>
        </div>
    </div>
    
    <div class="dashboard-actions">
        <a href="/offers" class="btn btn-primary">Browse Offers</a>
        <button id="request-payout-btn" class="btn btn-secondary" <%= user.balance < 5 ? 'disabled' : '' %>>
            Request Payout ($5 min)
        </button>
    </div>
    
    <div class="dashboard-sections">
        <div class="section">
            <h2>Recent Earnings</h2>
            <div id="recent-earnings" class="list-container">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <div class="section">
            <h2>Recent Offers</h2>
            <div id="recent-offers" class="list-container">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Load dashboard data
async function loadDashboardData() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        const response = await fetch('/api/dashboard/stats', {
            headers: {
                'Authorization': `Bearer ${token}`,
            },
        });
        
        if (!response.ok) {
            throw new Error('Failed to load dashboard data');
        }
        
        const data = await response.json();
        
        // Update recent earnings
        const earningsContainer = document.getElementById('recent-earnings');
        if (data.recentEarnings.length > 0) {
            earningsContainer.innerHTML = data.recentEarnings.map(earning => `
                <div class="list-item">
                    <div class="item-icon">ðŸ’°</div>
                    <div class="item-content">
                        <h4>${earning.description}</h4>
                        <p class="item-meta">$${earning.amount.toFixed(2)} â€¢ ${new Date(earning.createdAt).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
        } else {
            earningsContainer.innerHTML = '<p class="empty-state">No earnings yet. Complete your first offer!</p>';
        }
        
        // Update recent offers
        const offersContainer = document.getElementById('recent-offers');
        if (data.recentOffers.length > 0) {
            offersContainer.innerHTML = data.recentOffers.map(offer => `
                <div class="list-item">
                    <div class="item-icon">ðŸ“‹</div>
                    <div class="item-content">
                        <h4>Offer #${offer.offerId}</h4>
                        <p class="item-meta">$${offer.rewardAmount?.toFixed(2) || '0.00'} â€¢ ${offer.status} â€¢ ${new Date(offer.startedAt).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
        } else {
            offersContainer.innerHTML = '<p class="empty-state">No offers started yet. Browse available offers!</p>';
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Request payout
document.getElementById('request-payout-btn').addEventListener('click', async function() {
    const balance = <%= user.balance %>;
    if (balance < 5) {
        alert('You need at least $5 to request a payout.');
        return;
    }
    
    const amount = prompt(`Enter payout amount (min $5, max $${balance.toFixed(2)}):`, balance.toFixed(2));
    if (!amount || parseFloat(amount) < 5 || parseFloat(amount) > balance) {
        alert('Invalid amount. Please enter a value between $5 and your current balance.');
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/payouts/request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify({ amount: parseFloat(amount) }),
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Payout request submitted successfully! You will receive payment via PayPal.');
            location.reload(); // Refresh to update balance
        } else {
            alert(result.error || 'Failed to request payout.');
        }
    } catch (error) {
        alert('Failed to request payout. Please try again.');
    }
});

// Load data on page load
document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
